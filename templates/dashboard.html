<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SMART WAF AI - SOC</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Courier New', Courier, monospace; padding: 20px; }
        
        /* HEADER */
        .header { border-bottom: 2px solid #30363d; padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: #58a6ff; margin: 0; }
        
        /* CARTES CHIFFRES */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: #161b22; border: 1px solid #30363d; padding: 20px; border-radius: 8px; text-align: center; }
        .card p { margin: 10px 0 0; font-size: 30px; font-weight: bold; }
        .text-green { color: #3fb950; } .text-red { color: #f85149; } .text-blue { color: #58a6ff; }
        
        /* LAYOUT PRINCIPAL (Logs + Classement) */
        .main-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* CONTAINERS GENERIQUES */
        .panel { background: #161b22; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; padding: 15px; }
        h3 { margin-top: 0; border-bottom: 1px solid #30363d; padding-bottom: 10px; color: #8b949e; font-size: 14px; text-transform: uppercase; }

        /* TABLEAU */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; color: #8b949e; font-size: 12px; }
        td { padding: 8px; border-bottom: 1px solid #21262d; font-size: 13px; }
        
        /* BARRES DE PROGRESSION (CLASSEMENT) */
        .rank-item { margin-bottom: 15px; }
        .rank-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .progress-bg { background: #30363d; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
        
        /* COULEURS */
        .c-sqli { background-color: #d29922; }
        .c-xss { background-color: #8957e5; }
        .c-dos { background-color: #f85149; }
        .c-path { background-color: #d2a8ff; }
        .c-def { background-color: #79c0ff; }

        .badge { padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> SMART WAF SOC</h1>
        <div style="background:#238636;color:white;padding:5px 10px;border-radius:5px;">LIVE</div>
    </div>

    <div class="stats-grid">
        <div class="card"><h3>TOTAL TRAFIC</h3><p id="total_req" class="text-blue">0</p></div>
        <div class="card"><h3>MENACES BLOQUÃ‰ES</h3><p id="blocked_req" class="text-red">0</p></div>
        <div class="card"><h3>TRAFIC LÃ‰GITIME</h3><p id="allowed_req" class="text-green">0</p></div>
    </div>

    <div class="main-container">
        
        <div class="panel">
            <h3>ðŸ”´ Journal des Menaces (Temps RÃ©el)</h3>
            <table>
                <thead>
                    <tr>
                        <th>HEURE</th>
                        <th>IP</th>
                        <th>TYPE</th>
                        <th>SCORE</th>
                    </tr>
                </thead>
                <tbody id="log-table"></tbody>
            </table>
        </div>

        <div class="panel">
            <h3>ðŸ“Š Top Menaces</h3>
            <div id="ranking-container">
                </div>
        </div>

    </div>

    <script>
        function getColor(type) {
            if(type.includes("SQL")) return "c-sqli";
            if(type.includes("XSS")) return "c-xss";
            if(type.includes("DoS")) return "c-dos";
            if(type.includes("Path")) return "c-path";
            return "c-def";
        }

        function fetchStats() {
            fetch('/api/stats').then(r => r.json()).then(data => {
                // Mise Ã  jour Chiffres
                document.getElementById('total_req').innerText = data.total;
                document.getElementById('blocked_req').innerText = data.blocked;
                document.getElementById('allowed_req').innerText = data.allowed;

                // Mise Ã  jour Tableau Logs
                const tbody = document.getElementById('log-table');
                tbody.innerHTML = '';
                data.logs.slice().reverse().forEach(log => {
                    const colorClass = getColor(log.type).replace('c-', 'bg-'); // Astuce pour rÃ©utiliser les couleurs
                    const row = document.createElement('tr');
                    if(log.action === "BLOCKED") row.style.color = "#f85149";
                    
                    row.innerHTML = `
                        <td>${log.time}</td>
                        <td>${log.ip}</td>
                        <td style="font-size:11px;">${log.type}</td>
                        <td><b>${(log.score * 100).toFixed(0)}%</b></td>
                    `;
                    tbody.appendChild(row);
                });

                // Mise Ã  jour Classement (NOUVEAU)
                const rankContainer = document.getElementById('ranking-container');
                rankContainer.innerHTML = '';
                
                // On transforme l'objet en liste triÃ©e
                const sortedAttacks = Object.entries(data.attack_types)
                    .sort(([,a], [,b]) => b - a); // Tri du plus grand au plus petit

                const totalAttacks = data.blocked || 1; // Eviter division par zero

                sortedAttacks.forEach(([type, count]) => {
                    if(count > 0) { // On affiche seulement s'il y a eu au moins 1 attaque
                        const percent = (count / totalAttacks) * 100;
                        const barColor = getColor(type);
                        
                        rankContainer.innerHTML += `
                            <div class="rank-item">
                                <div class="rank-header">
                                    <span>${type}</span>
                                    <span>${count}</span>
                                </div>
                                <div class="progress-bg">
                                    <div class="progress-fill ${barColor}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
        }
        setInterval(fetchStats, 1000);
        fetchStats();
    </script>
</body>
</html>
